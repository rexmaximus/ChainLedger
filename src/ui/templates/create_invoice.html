{% extends "base.html" %}

{% block title %}Create Invoice - ChainLedger{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Create Invoice</h1>
    <p class="subtitle">Generate a professional PDF invoice for your crypto payment</p>
</div>

<div class="card">
    <form id="invoiceForm" onsubmit="createInvoice(event)">
        <!-- Sender Information -->
        <fieldset>
            <legend>Your Information (Sender)</legend>

            <div class="form-row">
                <div class="form-group">
                    <label for="senderName">Name *</label>
                    <input type="text" id="senderName" required
                           value="{{ sender_profile.name if sender_profile else '' }}">
                </div>
                <div class="form-group">
                    <label for="senderEmail">Email *</label>
                    <input type="email" id="senderEmail" required
                           value="{{ sender_profile.email if sender_profile else '' }}">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="senderBusiness">Business Name</label>
                    <input type="text" id="senderBusiness"
                           value="{{ sender_profile.business_name if sender_profile else '' }}">
                </div>
                <div class="form-group">
                    <label for="senderTaxId">Tax ID</label>
                    <input type="text" id="senderTaxId"
                           value="{{ sender_profile.tax_id if sender_profile else '' }}">
                </div>
            </div>

            <div class="form-group">
                <label for="senderWallet">Your Wallet Address (for payment) *</label>
                <input type="text" id="senderWallet" required placeholder="0x..."
                       value="{{ sender_profile.wallet if sender_profile else '' }}">
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="saveProfile" checked>
                    Save my profile for future invoices
                </label>
            </div>
        </fieldset>

        <!-- Recipient Information -->
        <fieldset>
            <legend>Client Information (Recipient)</legend>

            <div class="form-row">
                <div class="form-group">
                    <label for="recipientName">Client Name *</label>
                    <input type="text" id="recipientName" required>
                </div>
                <div class="form-group">
                    <label for="recipientEmail">Client Email *</label>
                    <input type="email" id="recipientEmail" required>
                </div>
            </div>

            <div class="form-group">
                <label for="recipientWallet">Client Wallet (Optional)</label>
                <input type="text" id="recipientWallet" placeholder="0x...">
            </div>
        </fieldset>

        <!-- Payment Details -->
        <fieldset>
            <legend>Payment Details</legend>

            <div class="form-row">
                <div class="form-group">
                    <label for="cryptoAmount">Amount *</label>
                    <input type="number" id="cryptoAmount" step="any" min="0" required
                           onchange="updateFiatValue()">
                </div>
                <div class="form-group">
                    <label for="tokenType">Token *</label>
                    <select id="tokenType" onchange="updateFiatValue()">
                        <option value="ETH">ETH (Ethereum)</option>
                        <option value="BTC">BTC (Bitcoin)</option>
                        <option value="USDC">USDC</option>
                        <option value="USDT">USDT</option>
                        <option value="DAI">DAI</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <div class="fiat-preview" id="fiatPreview">
                    Enter amount to see USD/CAD equivalent
                </div>
            </div>

            <div class="form-group">
                <label for="workDescription">Work Description</label>
                <textarea id="workDescription" rows="3"
                          placeholder="Describe the work or services provided..."></textarea>
            </div>

            <div class="form-group">
                <label for="invoiceNotes">Notes (Optional)</label>
                <textarea id="invoiceNotes" rows="2"
                          placeholder="Payment terms, additional notes..."></textarea>
            </div>
        </fieldset>

        <!-- Options -->
        <fieldset>
            <legend>Options</legend>

            <div class="form-group">
                <label for="invoiceNumber">Invoice Number</label>
                <input type="text" id="invoiceNumber" placeholder="Auto-generated if left blank">
            </div>

            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="includeFiat" checked>
                    Include USD/CAD equivalent
                </label>
            </div>
        </fieldset>

        <!-- Submit -->
        <div class="form-actions">
            <a href="/invoices" class="btn">Cancel</a>
            <button type="submit" class="btn btn-primary btn-large" id="createBtn">
                Create Invoice
            </button>
        </div>
    </form>

    <!-- Result Section -->
    <div id="resultSection" class="result-section" style="display: none;">
        <div class="result-card success">
            <h3>Invoice Created!</h3>
            <p id="resultMessage"></p>
            <div class="result-actions">
                <a id="downloadInvoice" href="#" class="btn btn-primary">Download PDF</a>
                <a href="/invoices/create" class="btn">Create Another</a>
                <a href="/invoices" class="btn">View All Invoices</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPrices = {};

async function updateFiatValue() {
    const amount = parseFloat(document.getElementById('cryptoAmount').value) || 0;
    const token = document.getElementById('tokenType').value;
    const preview = document.getElementById('fiatPreview');

    if (amount <= 0) {
        preview.textContent = 'Enter amount to see USD/CAD equivalent';
        return;
    }

    preview.innerHTML = '<span class="loading-text">Fetching current price...</span>';

    try {
        const response = await fetch(`/invoices/api/current-price?token=${token}`);
        const data = await response.json();

        if (data.usd) {
            currentPrices = data;
            const usdValue = (amount * data.usd).toFixed(2);
            const cadValue = (amount * data.cad).toFixed(2);
            preview.innerHTML = `
                <strong>$${parseFloat(usdValue).toLocaleString('en-US')} USD</strong> |
                <strong>$${parseFloat(cadValue).toLocaleString('en-US')} CAD</strong>
                <br><small>at current ${token} price</small>
            `;
        } else {
            preview.textContent = 'Price unavailable';
        }
    } catch (error) {
        preview.textContent = 'Failed to fetch price';
    }
}

async function createInvoice(event) {
    event.preventDefault();

    document.getElementById('createBtn').disabled = true;
    document.getElementById('createBtn').textContent = 'Creating...';

    const data = {
        sender_name: document.getElementById('senderName').value,
        sender_email: document.getElementById('senderEmail').value,
        sender_wallet: document.getElementById('senderWallet').value,
        sender_business: document.getElementById('senderBusiness').value,
        sender_tax_id: document.getElementById('senderTaxId').value,
        recipient_name: document.getElementById('recipientName').value,
        recipient_email: document.getElementById('recipientEmail').value,
        recipient_wallet: document.getElementById('recipientWallet').value,
        crypto_amount: parseFloat(document.getElementById('cryptoAmount').value),
        token_type: document.getElementById('tokenType').value,
        work_description: document.getElementById('workDescription').value,
        notes: document.getElementById('invoiceNotes').value,
        invoice_number: document.getElementById('invoiceNumber').value || null,
        include_fiat_value: document.getElementById('includeFiat').checked,
        save_profile: document.getElementById('saveProfile').checked,
    };

    try {
        const response = await fetch('/invoices/api/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });

        const result = await response.json();

        if (result.success) {
            document.getElementById('invoiceForm').style.display = 'none';
            document.getElementById('resultSection').style.display = 'block';

            let message = `Invoice <strong>${result.invoice_number}</strong> created successfully.`;
            if (result.usd_value) {
                message += `<br>Value: $${result.usd_value.toFixed(2)} USD / $${result.cad_value.toFixed(2)} CAD`;
            }

            document.getElementById('resultMessage').innerHTML = message;
            document.getElementById('downloadInvoice').href = result.download_url;
        } else {
            alert(result.error || 'Failed to create invoice');
            document.getElementById('createBtn').disabled = false;
            document.getElementById('createBtn').textContent = 'Create Invoice';
        }
    } catch (error) {
        alert('Error: ' + error.message);
        document.getElementById('createBtn').disabled = false;
        document.getElementById('createBtn').textContent = 'Create Invoice';
    }
}
</script>
{% endblock %}
