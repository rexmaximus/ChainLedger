{% extends "base.html" %}

{% block title %}Accounting Export - ChainLedger{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Accounting Export</h1>
    <p class="subtitle">Fetch wallet transactions and generate accounting reports</p>
</div>

<div class="card">
    <form id="exportForm" onsubmit="generateExport(event)">
        <!-- Blockchain Selection -->
        <div class="form-group">
            <label for="blockchain">Blockchain</label>
            <select id="blockchain" onchange="updateApiKeyVisibility()">
                {% for key, network in networks.items() %}
                <option value="{{ key }}"
                        data-requires-key="{{ network.requires_api_key|lower }}"
                        data-key-label="{{ network.api_key_label }}"
                        data-key-hint="{{ network.api_key_hint }}">
                    {{ network.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Wallet Addresses -->
        <div class="form-group">
            <label for="walletAddresses">Wallet Address(es)</label>
            <textarea id="walletAddresses" rows="2" placeholder="Enter one or more wallet addresses (comma-separated)"></textarea>
            <small class="form-hint">You can enter multiple addresses separated by commas</small>

            {% if wallets %}
            <div class="saved-wallets">
                <small>Quick add:</small>
                {% for wallet in wallets %}
                <button type="button" class="tag" onclick="addWalletAddress('{{ wallet.address }}')"
                        title="{{ wallet.address }}">
                    {{ wallet.name }}
                </button>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- API Key -->
        <div class="form-group" id="apiKeyGroup">
            <label for="apiKey" id="apiKeyLabel">Alchemy API Key</label>
            <input type="password" id="apiKey" placeholder="Enter your API key">
            <small class="form-hint" id="apiKeyHint">Get your free API key at alchemy.com</small>
        </div>

        <!-- Date Range -->
        <div class="form-group">
            <label>Time Scope</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="timeScope" value="all" checked onchange="toggleDateRange()">
                    All Time
                </label>
                <label class="radio-label">
                    <input type="radio" name="timeScope" value="range" onchange="toggleDateRange()">
                    Date Range
                </label>
            </div>
        </div>

        <div id="dateRangeFields" class="form-row" style="display: none;">
            <div class="form-group">
                <label for="fromDate">From Date</label>
                <input type="date" id="fromDate">
            </div>
            <div class="form-group">
                <label for="toDate">To Date</label>
                <input type="date" id="toDate">
            </div>
        </div>

        <!-- Options -->
        <div class="form-group">
            <label>Options</label>
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="includePrices" checked>
                    Include USD/CAD values (requires CoinGecko API - may be slow)
                </label>
            </div>
        </div>

        <!-- Output Format -->
        <div class="form-group">
            <label>Output Format</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="outputFormat" value="csv" checked>
                    CSV
                </label>
                <label class="radio-label">
                    <input type="radio" name="outputFormat" value="xlsx">
                    Excel (XLSX)
                </label>
            </div>
        </div>

        <!-- Submit -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-large" id="generateBtn">
                Generate Export
            </button>
        </div>
    </form>

    <!-- Progress/Result -->
    <div id="progressSection" class="progress-section" style="display: none;">
        <div class="progress-bar">
            <div class="progress-bar-fill" id="progressFill"></div>
        </div>
        <p id="progressText">Fetching transactions...</p>
    </div>

    <div id="resultSection" class="result-section" style="display: none;">
        <div class="result-card success">
            <h3>Export Complete!</h3>
            <div id="resultDetails"></div>
            <a id="downloadLink" href="#" class="btn btn-primary">Download Export</a>
        </div>
    </div>

    <div id="errorSection" class="result-section" style="display: none;">
        <div class="result-card error">
            <h3>Export Failed</h3>
            <p id="errorMessage"></p>
        </div>
    </div>
</div>

<!-- Recent Exports -->
<div class="section">
    <h2>Recent Exports</h2>
    <div id="recentExports" class="list">
        <p class="loading">Loading...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateApiKeyVisibility();
    loadRecentExports();
});

function updateApiKeyVisibility() {
    const select = document.getElementById('blockchain');
    const option = select.options[select.selectedIndex];
    const requiresKey = option.dataset.requiresKey === 'true';
    const group = document.getElementById('apiKeyGroup');

    if (requiresKey) {
        group.style.display = 'block';
        document.getElementById('apiKeyLabel').textContent = option.dataset.keyLabel;
        document.getElementById('apiKeyHint').textContent = option.dataset.keyHint;
    } else {
        group.style.display = 'none';
    }
}

function toggleDateRange() {
    const isRange = document.querySelector('input[name="timeScope"]:checked').value === 'range';
    document.getElementById('dateRangeFields').style.display = isRange ? 'flex' : 'none';
}

function addWalletAddress(address) {
    const textarea = document.getElementById('walletAddresses');
    const current = textarea.value.trim();
    if (current) {
        if (!current.includes(address)) {
            textarea.value = current + ', ' + address;
        }
    } else {
        textarea.value = address;
    }
}

async function generateExport(event) {
    event.preventDefault();

    // Hide previous results
    document.getElementById('resultSection').style.display = 'none';
    document.getElementById('errorSection').style.display = 'none';

    // Show progress
    document.getElementById('progressSection').style.display = 'block';
    document.getElementById('generateBtn').disabled = true;

    const timeScope = document.querySelector('input[name="timeScope"]:checked').value;
    const outputFormat = document.querySelector('input[name="outputFormat"]:checked').value;

    const data = {
        wallet_addresses: document.getElementById('walletAddresses').value,
        blockchain: document.getElementById('blockchain').value,
        api_key: document.getElementById('apiKey').value,
        time_scope: timeScope,
        from_date: timeScope === 'range' ? document.getElementById('fromDate').value : null,
        to_date: timeScope === 'range' ? document.getElementById('toDate').value : null,
        output_format: outputFormat,
        include_prices: document.getElementById('includePrices').checked,
    };

    try {
        const response = await fetch('/accounting/api/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
        });

        const result = await response.json();

        document.getElementById('progressSection').style.display = 'none';
        document.getElementById('generateBtn').disabled = false;

        if (result.success && result.transaction_count > 0) {
            document.getElementById('resultSection').style.display = 'block';

            let details = `<p><strong>${result.transaction_count}</strong> transactions exported</p>`;
            if (result.totals) {
                const t = result.totals;
                const fmt = (v) => v.toLocaleString('en-US', {minimumFractionDigits: 2});

                details += `<table class="summary-table">`;
                details += `<tr><td>Income transactions:</td><td>${t.income_count || 0}</td></tr>`;
                details += `<tr><td>Expense transactions:</td><td>${t.expense_count || 0}</td></tr>`;
                if (t.transfer_count) details += `<tr><td>Transfer transactions:</td><td>${t.transfer_count}</td></tr>`;
                if (t.unknown_count) details += `<tr><td>Unknown transactions:</td><td>${t.unknown_count}</td></tr>`;
                details += `</table>`;

                details += `<table class="summary-table">`;
                details += `<tr class="revenue"><td>Gross Revenue:</td><td><strong>$${fmt(t.gross_revenue_usd)} USD</strong> / <strong>$${fmt(t.gross_revenue_cad)} CAD</strong></td></tr>`;
                details += `<tr class="expense"><td>Total Expenses:</td><td><strong>$${fmt(t.total_expenses_usd)} USD</strong> / <strong>$${fmt(t.total_expenses_cad)} CAD</strong></td></tr>`;
                details += `<tr class="net"><td>Net Cash Flow:</td><td><strong>$${fmt(t.net_cash_flow_usd)} USD</strong> / <strong>$${fmt(t.net_cash_flow_cad)} CAD</strong></td></tr>`;
                details += `</table>`;
            }

            document.getElementById('resultDetails').innerHTML = details;
            document.getElementById('downloadLink').href = result.download_url;

            loadRecentExports();
        } else if (result.success && result.transaction_count === 0) {
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('errorMessage').textContent = result.message || 'No transactions found for this wallet in the specified range.';
        } else {
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('errorMessage').textContent = result.error || 'Unknown error';
        }
    } catch (error) {
        document.getElementById('progressSection').style.display = 'none';
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('errorSection').style.display = 'block';
        document.getElementById('errorMessage').textContent = error.message;
    }
}

async function loadRecentExports() {
    try {
        const response = await fetch('/accounting/api/exports');
        const exports = await response.json();

        const container = document.getElementById('recentExports');

        if (exports.length === 0) {
            container.innerHTML = '<p class="empty-state">No exports yet</p>';
            return;
        }

        container.innerHTML = exports.map(exp => `
            <div class="list-item">
                <div class="list-item-main">
                    <div class="list-item-title">${exp.blockchain.charAt(0).toUpperCase() + exp.blockchain.slice(1)} Export</div>
                    <div class="list-item-subtitle">${exp.transaction_count} transactions | ${new Date(exp.created_at).toLocaleDateString()}</div>
                </div>
                <a href="/accounting/api/download/${exp.filename}" class="btn btn-small">Download</a>
            </div>
        `).join('');
    } catch (error) {
        document.getElementById('recentExports').innerHTML = '<p class="error">Failed to load exports</p>';
    }
}
</script>
{% endblock %}
